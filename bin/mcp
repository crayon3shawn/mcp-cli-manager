#!/bin/zsh

# MCP ç®¡ç†å·¥å…·
MCP_DIR="${0:A:h}"
SERVERS_CONF="${HOME}/.config/mcp-manager/servers.conf"

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# å¹«åŠ©ä¿¡æ¯
show_help() {
    cat << EOF
${BLUE}MCP ç®¡ç†å·¥å…·${NC}

ç”¨æ³•: mcp <å‘½ä»¤> [åƒæ•¸]

å‘½ä»¤:
  ${GREEN}help${NC}             é¡¯ç¤ºæ­¤å¹«åŠ©ä¿¡æ¯
  ${GREEN}status${NC}           é¡¯ç¤ºæ‰€æœ‰æœå‹™å™¨ç‹€æ…‹
  ${GREEN}start [server]${NC}   å•Ÿå‹•æœå‹™å™¨ï¼ˆä¸æŒ‡å®šå‰‡å•Ÿå‹•æ‰€æœ‰ï¼‰
  ${GREEN}stop [server]${NC}    åœæ­¢æœå‹™å™¨ï¼ˆä¸æŒ‡å®šå‰‡åœæ­¢æ‰€æœ‰ï¼‰
  ${GREEN}restart [server]${NC} é‡å•Ÿæœå‹™å™¨ï¼ˆä¸æŒ‡å®šå‰‡é‡å•Ÿæ‰€æœ‰ï¼‰
  ${GREEN}logs [server]${NC}    æŸ¥çœ‹æœå‹™å™¨æ—¥èªŒ
  ${GREEN}doctor${NC}           è¨ºæ–·ç’°å¢ƒå•é¡Œ
  ${GREEN}reload${NC}           é‡æ–°è¼‰å…¥é…ç½®

æœå‹™å™¨:
  ${YELLOW}github${NC}          GitHub æ•´åˆæœå‹™å™¨
  ${YELLOW}filesystem${NC}      æ–‡ä»¶ç³»çµ±æœå‹™å™¨
  ${YELLOW}puppeteer${NC}       Puppeteer è‡ªå‹•åŒ–æœå‹™å™¨
  ${YELLOW}sequential${NC}      é †åºæ€ç¶­æœå‹™å™¨

ç¤ºä¾‹:
  mcp start          # å•Ÿå‹•æ‰€æœ‰æœå‹™å™¨
  mcp start github   # åªå•Ÿå‹• GitHub æœå‹™å™¨
  mcp status         # æª¢æŸ¥æ‰€æœ‰æœå‹™å™¨ç‹€æ…‹
  mcp stop           # åœæ­¢æ‰€æœ‰æœå‹™å™¨
EOF
}

# æª¢æŸ¥æœå‹™å™¨é…ç½®æ–‡ä»¶
check_config() {
    if [[ ! -f "$SERVERS_CONF" ]]; then
        echo "${RED}éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ $SERVERS_CONF${NC}"
        return 1
    fi
}

# ç²å–æœå‹™å™¨ä¿¡æ¯
get_server_info() {
    local server=$1
    local field=$2
    sed -n "/^\[$server\]/,/^\[/p" "$SERVERS_CONF" | grep "^$field=" | cut -d= -f2
}

# åˆ—å‡ºæ‰€æœ‰æœå‹™å™¨
list_servers() {
    grep '^\[.*\]$' "$SERVERS_CONF" | tr -d '[]'
}

# æª¢æŸ¥æœå‹™å™¨ç‹€æ…‹
check_server_status() {
    local server=$1
    local process=$(get_server_info "$server" "process")
    if pgrep -f "$process" > /dev/null; then
        echo "${GREEN}âœ… $(get_server_info "$server" "description") æ­£åœ¨é‹è¡Œ${NC}"
        return 0
    else
        echo "${RED}âŒ $(get_server_info "$server" "description") æœªé‹è¡Œ${NC}"
        return 1
    fi
}

# å•Ÿå‹•æœå‹™å™¨
start_server() {
    local server=$1
    local command=$(get_server_info "$server" "command")
    local description=$(get_server_info "$server" "description")
    
    echo "${BLUE}â–¶ï¸ å•Ÿå‹•${description}...${NC}"
    eval "$command" &
    sleep 1
    check_server_status "$server"
}

# åœæ­¢æœå‹™å™¨
stop_server() {
    local server=$1
    local process=$(get_server_info "$server" "process")
    local description=$(get_server_info "$server" "description")
    
    echo "${YELLOW}ğŸ›‘ åœæ­¢${description}...${NC}"
    if pkill -f "$process"; then
        echo "${GREEN}âœ… ${description}å·²åœæ­¢${NC}"
        return 0
    else
        echo "${RED}âŒ ${description}åœæ­¢å¤±æ•—${NC}"
        return 1
    fi
}

# æª¢æŸ¥ç’°å¢ƒ
check_environment() {
    echo "${BLUE}ğŸ” æª¢æŸ¥ MCP ç’°å¢ƒ...${NC}"
    
    # æª¢æŸ¥ fnm
    if ! command -v fnm >/dev/null 2>&1; then
        echo "${RED}âŒ æœªå®‰è£ fnm${NC}"
        return 1
    fi
    
    # æª¢æŸ¥ Node.js ç‰ˆæœ¬
    local current_version=$(fnm current)
    if [[ "$current_version" != "mcp-servers" ]]; then
        echo "${YELLOW}âš ï¸ ç•¶å‰ä¸åœ¨ MCP ç’°å¢ƒï¼ˆç•¶å‰ï¼š$current_versionï¼‰${NC}"
        echo "${BLUE}ğŸ”„ åˆ‡æ›åˆ° MCP ç’°å¢ƒ...${NC}"
        if ! fnm use mcp-servers; then
            echo "${RED}âŒ åˆ‡æ›åˆ° MCP ç’°å¢ƒå¤±æ•—${NC}"
            return 1
        fi
    fi
    
    echo "${GREEN}âœ… ç’°å¢ƒæª¢æŸ¥é€šé${NC}"
    return 0
}

# ä¸»è¦å‘½ä»¤è™•ç†
case "$1" in
    help|--help|-h)
        show_help
        ;;
    status)
        check_config || exit 1
        echo "${BLUE}ğŸ” æª¢æŸ¥æ‰€æœ‰æœå‹™å™¨ç‹€æ…‹...${NC}"
        local running=0
        local total=0
        for server in $(list_servers); do
            check_server_status "$server" && ((running++))
            ((total++))
        done
        echo "${BLUE}ğŸ“Š ç¸½çµï¼š${GREEN}$running${NC}/${total} å€‹æœå‹™å™¨æ­£åœ¨é‹è¡Œ${NC}"
        ;;
    start)
        check_config || exit 1
        check_environment || exit 1
        if [[ -n "$2" ]]; then
            start_server "$2"
        else
            echo "${BLUE}ğŸš€ å•Ÿå‹•æ‰€æœ‰æœå‹™å™¨...${NC}"
            for server in $(list_servers); do
                start_server "$server"
            done
        fi
        ;;
    stop)
        check_config || exit 1
        if [[ -n "$2" ]]; then
            stop_server "$2"
        else
            echo "${YELLOW}ğŸ›‘ åœæ­¢æ‰€æœ‰æœå‹™å™¨...${NC}"
            for server in $(list_servers); do
                stop_server "$server"
            done
        fi
        ;;
    restart)
        check_config || exit 1
        check_environment || exit 1
        if [[ -n "$2" ]]; then
            stop_server "$2"
            sleep 2
            start_server "$2"
        else
            echo "${BLUE}ğŸ”„ é‡å•Ÿæ‰€æœ‰æœå‹™å™¨...${NC}"
            for server in $(list_servers); do
                stop_server "$server"
            done
            sleep 2
            for server in $(list_servers); do
                start_server "$server"
            done
        fi
        ;;
    doctor)
        check_config || exit 1
        echo "${BLUE}ğŸ¥ åŸ·è¡Œç³»çµ±è¨ºæ–·...${NC}"
        check_environment
        echo "${BLUE}ğŸ“¦ æª¢æŸ¥å·²å®‰è£çš„å¥—ä»¶...${NC}"
        for server in $(list_servers); do
            local command=$(get_server_info "$server" "command")
            if [[ -f $(echo "$command" | cut -d' ' -f2) ]]; then
                echo "${GREEN}âœ… $(get_server_info "$server" "description") å·²å®‰è£${NC}"
            else
                echo "${RED}âŒ $(get_server_info "$server" "description") æœªå®‰è£${NC}"
            fi
        done
        ;;
    reload)
        echo "${BLUE}ğŸ”„ é‡æ–°è¼‰å…¥é…ç½®...${NC}"
        if [[ -f "$SERVERS_CONF" ]]; then
            echo "${GREEN}âœ… é…ç½®å·²é‡æ–°è¼‰å…¥${NC}"
        else
            echo "${RED}âŒ æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶${NC}"
        fi
        ;;
    *)
        echo "${RED}éŒ¯èª¤ï¼šæœªçŸ¥å‘½ä»¤ '$1'${NC}"
        echo "ä½¿ç”¨ 'mcp help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
        exit 1
        ;;
esac 