#!/bin/bash

# Import modules
source "$(dirname "${BASH_SOURCE[0]}")/../lib/core/env.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../lib/core/log.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../lib/config/loader.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../lib/process/manager.sh"

# Print usage
print_usage() {
    cat << EOF
Usage: $(basename "$0") <command> [options]

Commands:
  list                     列出所有已配置的服務器
  get <server>            顯示服務器詳細配置
  add <server>            添加新的服務器配置
  remove <server>         移除服務器配置
  import <file>           導入配置文件
  start <server>          啟動服務器
  stop <server>           停止服務器
  restart <server>        重啟服務器
  status <server>         查看服務器狀態

Options:
  -h, --help             顯示幫助信息
EOF
}

# Main
case "${1:-}" in
    "list")
        list_servers
        ;;
    "get")
        if [ -z "${2:-}" ]; then
            log_error "Server name required" \
                     "Usage: $(basename "$0") get <server>" \
                     "Use '$(basename "$0") list' to view available servers"
            exit 1
        fi
        get_server_config "$2"
        ;;
    "add")
        if [ -z "${2:-}" ]; then
            log_error "Server name required" \
                     "Usage: $(basename "$0") add <server>" \
                     "Example: $(basename "$0") add my-server"
            exit 1
        fi
        add_server_config "$2"
        ;;
    "remove")
        if [ -z "${2:-}" ]; then
            log_error "Server name required" \
                     "Usage: $(basename "$0") remove <server>" \
                     "Use '$(basename "$0") list' to view available servers"
            exit 1
        fi
        remove_server_config "$2"
        ;;
    "import")
        if [ -z "${2:-}" ]; then
            log_error "Configuration file path required" \
                     "Usage: $(basename "$0") import <file>" \
                     "Example: $(basename "$0") import ./my-config.json"
            exit 1
        fi
        import_config "$2"
        ;;
    "start")
        if [ -z "${2:-}" ]; then
            log_error "Server name required" \
                     "Usage: $(basename "$0") start <server>" \
                     "Use '$(basename "$0") list' to view available servers"
            exit 1
        fi
        start_server "$2"
        ;;
    "stop")
        if [ -z "${2:-}" ]; then
            log_error "Server name required" \
                     "Usage: $(basename "$0") stop <server>" \
                     "Use '$(basename "$0") list' to view available servers"
            exit 1
        fi
        stop_server "$2"
        ;;
    "restart")
        if [ -z "${2:-}" ]; then
            log_error "Server name required" \
                     "Usage: $(basename "$0") restart <server>" \
                     "Use '$(basename "$0") list' to view available servers"
            exit 1
        fi
        restart_server "$2"
        ;;
    "status")
        if [ -z "${2:-}" ]; then
            log_error "Server name required" \
                     "Usage: $(basename "$0") status <server>" \
                     "Use '$(basename "$0") list' to view available servers"
            exit 1
        fi
        get_server_status "$2"
        ;;
    "-h"|"--help")
        print_usage
        exit 0
        ;;
    *)
        log_error "Unknown command: ${1:-}" \
                 "Use '$(basename "$0") --help' to view available commands" \
                 "Or '$(basename "$0") list' to view configured servers"
        exit 1
        ;;
esac 